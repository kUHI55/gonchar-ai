import OpenAI from "openai";
import { NextResponse } from "next/server";

export const runtime = "nodejs";

// –∞–Ω—Ç–∏-—Å–ø–∞–º: 1 –∑–∞–ø—Ä–æ—Å / 2 —Å–µ–∫
let lastAskTime = 0;

function isRegionBlock(err) {
  const status = err?.status || err?.response?.status;
  const msg = String(err?.message || "");

  return (
    status === 403 ||
    msg.includes("Country, region, or territory not supported") ||
    msg.includes("region") ||
    msg.includes("territory")
  );
}

export async function POST(req) {
  try {
    const now = Date.now();
    if (now - lastAskTime < 2000) {
      return NextResponse.json(
        { error: "–ü–æ–¥–æ–∂–¥–∏ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –≤–æ–ø—Ä–æ—Å–æ–º üôÇ" },
        { status: 429 }
      );
    }
    lastAskTime = now;

    const { topic, question, theory, task } = await req.json();

    if (!question || !question.trim()) {
      return NextResponse.json({ error: "Question is required" }, { status: 400 });
    }

    const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

    // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å, —á—Ç–æ–±—ã –Ω–µ —É–ª–µ—Ç–µ—Ç—å –≤ –¥–æ—Ä–æ–≥—É—é
    const model = process.env.OPENAI_MODEL || "gpt-4.1-mini";

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç (—á—Ç–æ–±—ã —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –æ—Ç–≤–µ—á–∞–ª –ø–æ —Ç–µ–º–µ –∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–µ)
    const context = `
–¢–ï–ú–ê: ${topic || "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞"}

–ö–£–°–û–ö –¢–ï–û–†–ò–ò (–º–æ–∂–µ—Ç –±—ã—Ç—å markdown):
${theory || "(–Ω–µ—Ç)"}

–¢–ï–ö–£–©–ê–Ø –ó–ê–î–ê–ß–ê (–µ—Å–ª–∏ –µ—Å—Ç—å):
${task ? `${task.title}\n${task.prompt}` : "(–Ω–µ—Ç)"}
`.trim();

    // ‚úÖ –°–£–ü–ï–†-–°–ò–°–¢–ï–ú–ê: ¬´–∫–∞–∫ –¥—É–º–∞–µ—Ç —Ö–æ—Ä–æ—à–∏–π —É—á–∏—Ç–µ–ª—å¬ª
    const system = `
–¢—ã ‚Äî –ª—É—á—à–∏–π —à–∫–æ–ª—å–Ω—ã–π AI-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ –¥–ª—è —É—á–µ–Ω–∏–∫–∞ 10‚Äì16 –ª–µ—Ç.
–¢–≤–æ—è —Ü–µ–ª—å: –Ω–µ –ø—Ä–æ—Å—Ç–æ –¥–∞—Ç—å –æ—Ç–≤–µ—Ç, –∞ –¥–æ–≤–µ—Å—Ç–∏ —É—á–µ–Ω–∏–∫–∞ –¥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø (–ê–õ–ì–û–†–ò–¢–ú –£–ß–ò–¢–ï–õ–Ø):
1) –°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞:
   A) —É—á–µ–Ω–∏–∫ –ø—Ä–æ—Å–∏—Ç –æ–±—ä—è—Å–Ω–∏—Ç—å —Ç–µ–º—É
   B) —É—á–µ–Ω–∏–∫ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥/–≤–æ–ø—Ä–æ—Å
   C) —É—á–µ–Ω–∏–∫ –ø—Ä–∏—Å–ª–∞–ª —Å–≤–æ—ë —Ä–µ—à–µ–Ω–∏–µ (–∏–ª–∏ —á–∞—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è)
   D) —É—á–µ–Ω–∏–∫ –ø—Ä–æ—Å–∏—Ç ‚Äú–¥–∞–π –æ—Ç–≤–µ—Ç‚Äù/‚Äú—Ä–µ—à–∏ –∑–∞ –º–µ–Ω—è‚Äù

2) –ù–∏–∫–æ–≥–¥–∞ –Ω–µ ¬´—Å—ã–ø—å –ø—Ä–æ—Å—Ç—ã–Ω—é¬ª. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º:
   - –º–∞–∫—Å–∏–º—É–º 6‚Äì10 —Å—Ç—Ä–æ–∫,
   - —à–∞–≥–∏ 1), 2), 3)‚Ä¶
   - –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞.

3) –ù–ï –°–ü–û–ô–õ–ï–†–ò (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –∑–∞–¥–∞—á):
   - –µ—Å–ª–∏ —É—á–µ–Ω–∏–∫ —Ä–µ—à–∞–µ—Ç –∑–∞–¥–∞—á—É, –Ω–µ –≤—ã–¥–∞–≤–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É.
   - –¥–∞–π 1‚Äì2 –Ω–∞–≤–æ–¥—è—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–∫—É –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.
   - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –º–æ–∂–Ω–æ –¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—á–µ–Ω–∏–∫ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å–∏–ª ‚Äú–ø–æ–∫–∞–∂–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é‚Äù –ò —É–∂–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª.

4) –ï—Å–ª–∏ —É—á–µ–Ω–∏–∫ –ø—Ä–∏—Å–ª–∞–ª —Ä–µ—à–µ–Ω–∏–µ:
   - —Å–Ω–∞—á–∞–ª–∞ –∫–æ—Ä–æ—Ç–∫–æ –ø–æ—Ö–≤–∞–ª–∏ –ø–æ–ø—ã—Ç–∫—É,
   - –Ω–∞–π–¥–∏ –ü–ï–†–í–£–Æ –æ—à–∏–±–∫—É (–∏–ª–∏ –º–µ—Å—Ç–æ, –≥–¥–µ –ª–æ–≥–∏–∫–∞ –ª–æ–º–∞–µ—Ç—Å—è),
   - —Å–∫–∞–∂–∏: ‚Äú–æ—à–∏–±–∫–∞ –Ω–∞ —à–∞–≥–µ N‚Äù, –æ–±—ä—è—Å–Ω–∏ –ø–æ—á–µ–º—É,
   - –∑–∞–¥–∞–π 1 –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–ø—Ä–∞–≤–∏—Ç –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é,
   - –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.

5) –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ–ø–æ–ª–Ω—ã–π –∏–ª–∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –¥–∞–Ω–æ:
   - –∑–∞–¥–∞–π –û–î–ò–ù —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å, –Ω–µ –±–æ–ª—å—à–µ.

6) –ü—Ä–∏–º–µ—Ä—ã:
   - –µ—Å–ª–∏ –æ–±—ä—è—Å–Ω—è–µ—à—å —Ç–µ–º—É ‚Äî –¥–∞–π 1 –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–∏–º–µ—Ä,
   - –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—à—å –∑–∞–¥–∞—á—É ‚Äî –ø—Ä–∏–º–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å –æ—à–∏–±–∫—É.

7) –¢–æ–Ω:
   - –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –ø–æ –¥–µ–ª—É, –±–µ–∑ —É–º–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.
   - –µ—Å–ª–∏ —Ç–µ—Ä–º–∏–Ω –Ω—É–∂–µ–Ω ‚Äî –æ–±—ä—è—Å–Ω–∏ –≤ 1 —Ñ—Ä–∞–∑–µ.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å 1 –∫–æ—Ä–æ—Ç–∫–æ–π —Ñ—Ä–∞–∑—ã ‚Äú—á—Ç–æ –º—ã –¥–µ–ª–∞–µ–º —Å–µ–π—á–∞—Å‚Äù.
- –ó–∞—Ç–µ–º —à–∞–≥–∏/–ø–æ–¥—Å–∫–∞–∑–∫–∏.
- –í –∫–æ–Ω—Ü–µ 1 –≤–æ–ø—Ä–æ—Å —É—á–µ–Ω–∏–∫—É (—á—Ç–æ–±—ã –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∏–ª).
`.trim();

    const user = `
${context}

–í–û–ü–†–û–° –£–ß–ï–ù–ò–ö–ê:
${question}
`.trim();

    const resp = await client.responses.create({
      model,
      input: [
        { role: "system", content: system },
        { role: "user", content: user },
      ],
      max_output_tokens: 650,
    });

    const answer =
      resp.output_text?.trim() || "–ù–µ —Å–º–æ–≥ –æ—Ç–≤–µ—Ç–∏—Ç—å, –ø–æ–ø—Ä–æ–±—É–π —Å–ø—Ä–æ—Å–∏—Ç—å –∏–Ω–∞—á–µ.";

    return NextResponse.json({ answer });
  } catch (err) {
    if (isRegionBlock(err)) {
      return NextResponse.json(
        {
          code: "REGION_BLOCK",
          error:
            "OpenAI API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑-–∑–∞ VPN/—Ä–µ–≥–∏–æ–Ω–∞. –í—ã–∫–ª—é—á–∏ VPN –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.",
        },
        { status: 200 }
      );
    }

    return NextResponse.json(
      { error: err?.message || "Server error" },
      { status: 500 }
    );
  }
}
