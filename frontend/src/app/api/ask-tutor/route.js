import OpenAI from "openai";
import { NextResponse } from "next/server";

export const runtime = "nodejs";


let lastAskTime = 0;

function isRegionBlock(err) {
  const status = err?.status || err?.response?.status;
  const msg = String(err?.message || "");

  return (
    status === 403 ||
    msg.includes("Country, region, or territory not supported") ||
    msg.includes("region") ||
    msg.includes("territory")
  );
}

export async function POST(req) {
  try {
    const now = Date.now();
    if (now - lastAskTime < 2000) {
      return NextResponse.json(
        { error: "ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸ 2 ÑÐµÐºÑƒÐ½Ð´Ñ‹ Ð¿ÐµÑ€ÐµÐ´ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð¼ ðŸ™‚" },
        { status: 429 }
      );
    }
    lastAskTime = now;

    const { topic, question, theory, task } = await req.json();

    if (!question || !question.trim()) {
      return NextResponse.json({ error: "Question is required" }, { status: 400 });
    }

    const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

    
    const model = process.env.OPENAI_MODEL || "gpt-4.1-mini";

    
    const context = `
Ð¢Ð•ÐœÐ: ${topic || "Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ°"}

ÐšÐ£Ð¡ÐžÐš Ð¢Ð•ÐžÐ Ð˜Ð˜ (Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ markdown):
${theory || "(Ð½ÐµÑ‚)"}

Ð¢Ð•ÐšÐ£Ð©ÐÐ¯ Ð—ÐÐ”ÐÐ§Ð (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ):
${task ? `${task.title}\n${task.prompt}` : "(Ð½ÐµÑ‚)"}
`.trim();

    
    const system = `
Ð¢Ñ‹ â€” Ð»ÑƒÑ‡ÑˆÐ¸Ð¹ ÑˆÐºÐ¾Ð»ÑŒÐ½Ñ‹Ð¹ AI-Ñ€ÐµÐ¿ÐµÑ‚Ð¸Ñ‚Ð¾Ñ€ Ð¿Ð¾ Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐµ Ð´Ð»Ñ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ° 10â€“16 Ð»ÐµÑ‚.
Ð¢Ð²Ð¾Ñ Ñ†ÐµÐ»ÑŒ: Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð´Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚, Ð° Ð´Ð¾Ð²ÐµÑÑ‚Ð¸ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ° Ð´Ð¾ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ.

ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐŸÐžÐ’Ð•Ð”Ð•ÐÐ˜Ð¯ (ÐÐ›Ð“ÐžÐ Ð˜Ð¢Ðœ Ð£Ð§Ð˜Ð¢Ð•Ð›Ð¯):
1) Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸ Ñ‚Ð¸Ð¿ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:
   A) ÑƒÑ‡ÐµÐ½Ð¸Ðº Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ Ð¾Ð±ÑŠÑÑÐ½Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ¼Ñƒ
   B) ÑƒÑ‡ÐµÐ½Ð¸Ðº ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ ÑˆÐ°Ð³/Ð²Ð¾Ð¿Ñ€Ð¾Ñ
   C) ÑƒÑ‡ÐµÐ½Ð¸Ðº Ð¿Ñ€Ð¸ÑÐ»Ð°Ð» ÑÐ²Ð¾Ñ‘ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ (Ð¸Ð»Ð¸ Ñ‡Ð°ÑÑ‚ÑŒ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ)
   D) ÑƒÑ‡ÐµÐ½Ð¸Ðº Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ â€œÐ´Ð°Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚â€/â€œÑ€ÐµÑˆÐ¸ Ð·Ð° Ð¼ÐµÐ½Ñâ€

2) ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Â«ÑÑ‹Ð¿ÑŒ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð½ÑŽÂ». ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¼ Ð¸ Ð¿Ð¾Ð½ÑÑ‚Ð½Ñ‹Ð¼:
   - Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 6â€“10 ÑÑ‚Ñ€Ð¾Ðº,
   - ÑˆÐ°Ð³Ð¸ 1), 2), 3)â€¦
   - Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð°.

3) ÐÐ• Ð¡ÐŸÐžÐ™Ð›Ð•Ð Ð˜ (Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ Ð´Ð»Ñ Ð·Ð°Ð´Ð°Ñ‡):
   - ÐµÑÐ»Ð¸ ÑƒÑ‡ÐµÐ½Ð¸Ðº Ñ€ÐµÑˆÐ°ÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‡Ñƒ, Ð½Ðµ Ð²Ñ‹Ð´Ð°Ð²Ð°Ð¹ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ ÑÑ€Ð°Ð·Ñƒ.
   - Ð´Ð°Ð¹ 1â€“2 Ð½Ð°Ð²Ð¾Ð´ÑÑ‰Ð¸Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ° Ð¸ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÑƒ Ð½Ð° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÑˆÐ°Ð³.
   - Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÑƒÑ‡ÐµÐ½Ð¸Ðº ÑÐ²Ð½Ð¾ Ð¿Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ð» â€œÐ¿Ð¾ÐºÐ°Ð¶Ð¸ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽâ€ Ð˜ ÑƒÐ¶Ðµ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ð».

4) Ð•ÑÐ»Ð¸ ÑƒÑ‡ÐµÐ½Ð¸Ðº Ð¿Ñ€Ð¸ÑÐ»Ð°Ð» Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ:
   - ÑÐ½Ð°Ñ‡Ð°Ð»Ð° ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¿Ð¾Ñ…Ð²Ð°Ð»Ð¸ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ,
   - Ð½Ð°Ð¹Ð´Ð¸ ÐŸÐ•Ð Ð’Ð£Ð® Ð¾ÑˆÐ¸Ð±ÐºÑƒ (Ð¸Ð»Ð¸ Ð¼ÐµÑÑ‚Ð¾, Ð³Ð´Ðµ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð»Ð¾Ð¼Ð°ÐµÑ‚ÑÑ),
   - ÑÐºÐ°Ð¶Ð¸: â€œÐ¾ÑˆÐ¸Ð±ÐºÐ° Ð½Ð° ÑˆÐ°Ð³Ðµ Nâ€, Ð¾Ð±ÑŠÑÑÐ½Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ,
   - Ð·Ð°Ð´Ð°Ð¹ 1 Ð²Ð¾Ð¿Ñ€Ð¾Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ Ðº Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÑŽ,
   - Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ.

5) Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð½ÐµÐ¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð¸Ð»Ð¸ Ð½ÐµÐ¿Ð¾Ð½ÑÑ‚Ð½Ð¾, Ñ‡Ñ‚Ð¾ Ð´Ð°Ð½Ð¾:
   - Ð·Ð°Ð´Ð°Ð¹ ÐžÐ”Ð˜Ð ÑƒÑ‚Ð¾Ñ‡Ð½ÑÑŽÑ‰Ð¸Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ, Ð½Ðµ Ð±Ð¾Ð»ÑŒÑˆÐµ.

6) ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
   - ÐµÑÐ»Ð¸ Ð¾Ð±ÑŠÑÑÐ½ÑÐµÑˆÑŒ Ñ‚ÐµÐ¼Ñƒ â€” Ð´Ð°Ð¹ 1 ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€,
   - ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑˆÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ â€” Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¾Ð½ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð¿Ð¾Ð½ÑÑ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÑƒ.

7) Ð¢Ð¾Ð½:
   - Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ð¾, Ð¿Ð¾ Ð´ÐµÐ»Ñƒ, Ð±ÐµÐ· ÑƒÐ¼Ð½Ñ‹Ñ… Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð¾Ð².
   - ÐµÑÐ»Ð¸ Ñ‚ÐµÑ€Ð¼Ð¸Ð½ Ð½ÑƒÐ¶ÐµÐ½ â€” Ð¾Ð±ÑŠÑÑÐ½Ð¸ Ð² 1 Ñ„Ñ€Ð°Ð·Ðµ.

Ð¤ÐžÐ ÐœÐÐ¢ ÐžÐ¢Ð’Ð•Ð¢Ð:
- Ð’ÑÐµÐ³Ð´Ð° Ð½Ð°Ñ‡Ð¸Ð½Ð°Ð¹ Ñ 1 ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾Ð¹ Ñ„Ñ€Ð°Ð·Ñ‹ â€œÑ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð´ÐµÐ»Ð°ÐµÐ¼ ÑÐµÐ¹Ñ‡Ð°Ñâ€.
- Ð—Ð°Ñ‚ÐµÐ¼ ÑˆÐ°Ð³Ð¸/Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸.
- Ð’ ÐºÐ¾Ð½Ñ†Ðµ 1 Ð²Ð¾Ð¿Ñ€Ð¾Ñ ÑƒÑ‡ÐµÐ½Ð¸ÐºÑƒ (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ð»).
`.trim();

    const user = `
${context}

Ð’ÐžÐŸÐ ÐžÐ¡ Ð£Ð§Ð•ÐÐ˜ÐšÐ:
${question}
`.trim();

    const resp = await client.responses.create({
      model,
      input: [
        { role: "system", content: system },
        { role: "user", content: user },
      ],
      max_output_tokens: 650,
    });

    const answer =
      resp.output_text?.trim() || "ÐÐµ ÑÐ¼Ð¾Ð³ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¸Ð½Ð°Ñ‡Ðµ.";

    return NextResponse.json({ answer });
  } catch (err) {
    if (isRegionBlock(err)) {
      return NextResponse.json(
        {
          code: "REGION_BLOCK",
          error:
            "OpenAI API Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¸Ð·-Ð·Ð° VPN/Ñ€ÐµÐ³Ð¸Ð¾Ð½Ð°. Ð’Ñ‹ÐºÐ»ÑŽÑ‡Ð¸ VPN Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.",
        },
        { status: 200 }
      );
    }

    return NextResponse.json(
      { error: err?.message || "Server error" },
      { status: 500 }
    );
  }
}
